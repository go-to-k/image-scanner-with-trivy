"use strict";var f=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var B=Object.prototype.hasOwnProperty;var A=(o,t)=>{for(var e in t)f(o,e,{get:t[e],enumerable:!0})},D=(o,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of _(t))!B.call(o,r)&&r!==e&&f(o,r,{get:()=>t[r],enumerable:!(n=F(t,r))||n.enumerable});return o};var V=o=>D(f({},"__esModule",{value:!0}),o);var H={};A(H,{handler:()=>E});module.exports=V(H);var x=require("child_process"),b=require("fs");var h="/tmp/.trivyignore",$="/tmp/.trivyignore.yaml",w=o=>{let t=[];t.push("--no-progress");let e=o.output?.type==="s3"?o.output.sbomFormat:void 0;if(e&&t.push(`--format ${e}`),o.ignoreUnfixed==="true"&&t.push("--ignore-unfixed"),o.severity.length&&t.push(`--severity ${o.severity.join(",")}`),o.scanners.length&&t.push(`--scanners ${o.scanners.join(",")}`),o.imageConfigScanners.length&&t.push(`--image-config-scanners ${o.imageConfigScanners.join(",")}`),o.exitCode&&t.push(`--exit-code ${o.exitCode}`),o.exitOnEol&&t.push(`--exit-on-eol ${o.exitOnEol}`),o.exitCode==null&&t.push("--exit-code 1 --exit-on-eol 1"),o.trivyIgnore.length){let n=o.trivyIgnoreFileType==="TRIVYIGNORE_YAML"?$:h;t.push(`--ignorefile ${n}`)}return o.platform&&t.push(`--platform ${o.platform}`),t},k=(o,t)=>{let e=`/opt/trivy image ${t.join(" ")} ${o}`;return console.log("imageUri: "+o),console.log("command: "+e),(0,x.spawnSync)(e,{shell:!0,maxBuffer:50*1024*1024})},R=(o,t)=>{(0,b.writeFileSync)(t==="TRIVYIGNORE_YAML"?$:h,o.join(`
`),"utf-8")};var c=require("@aws-sdk/client-cloudwatch-logs"),m=new c.CloudWatchLogsClient,N=async(o,t,e)=>{let[n,r]=e.split(":"),s=r?`uri=${n},tag=${r}`:`uri=${n}`;try{await m.send(new c.CreateLogStreamCommand({logGroupName:t.logGroupName,logStreamName:s}))}catch(a){if(a instanceof c.ResourceAlreadyExistsException)console.log(`Log stream ${s} already exists in log group ${t.logGroupName}.`);else throw a}let i=new Date().getTime(),u={logGroupName:t.logGroupName,logStreamName:s,logEvents:[{timestamp:i,message:`stderr:
`+o.stderr.toString()},{timestamp:i,message:`stdout:
`+o.stdout.toString()}]},p=new c.PutLogEventsCommand(u);await m.send(p),console.log(`Scan logs output to the log group: ${t.logGroupName}, log stream: ${s}`)},T=async(o,t,e)=>{let[n,r]=e.split(":"),s=r?`uri=${n},tag=${r}`:`uri=${n}`,i=`${s}/stdout`,u=`${s}/stderr`,p=new Date().getTime();await I(t.logGroupName,i,p,o.stdout.toString()),await I(t.logGroupName,u,p,o.stderr.toString()),console.log(`Scan logs output to the log group: ${t.logGroupName}
  stdout stream: ${i}
  stderr stream: ${u}`)},I=async(o,t,e,n)=>{try{await m.send(new c.CreateLogStreamCommand({logGroupName:o,logStreamName:t}))}catch(i){if(i instanceof c.ResourceAlreadyExistsException)console.log(`Log stream ${t} already exists in log group ${o}.`);else throw i}let r={logGroupName:o,logStreamName:t,logEvents:[{timestamp:e,message:n}]},s=new c.PutLogEventsCommand(r);await m.send(s)};var g=require("@aws-sdk/client-s3");var O=new g.S3Client,v=async(o,t,e)=>{let n=new Date().toISOString(),[r,s]=e.split(":"),i=r.replace(/\//g,"_"),u=s?s.replace(/\//g,"_"):"latest",a=`${t.prefix?t.prefix.endsWith("/")?t.prefix:`${t.prefix}/`:""}${i}/${u}/${n}`,S=o.stderr.toString(),y=o.stdout.toString();if(t.sbomFormat){let L=t.sbomFormat==="spdx"?"spdx":"json",W=t.sbomFormat==="spdx"?"text/plain":"application/json";await O.send(new g.PutObjectCommand({Bucket:t.bucketName,Key:`${a}/sbom.${L}`,Body:y,ContentType:W})),console.log(`SBOM output to S3: s3://${t.bucketName}/${a}/sbom.${L}`)}else await Promise.all([O.send(new g.PutObjectCommand({Bucket:t.bucketName,Key:`${a}/stderr.txt`,Body:S,ContentType:"text/plain"})),O.send(new g.PutObjectCommand({Bucket:t.bucketName,Key:`${a}/stdout.txt`,Body:y,ContentType:"text/plain"}))]),console.log(`Scan logs output to S3:
  stderr: s3://${t.bucketName}/${a}/stderr.txt
  stdout: s3://${t.bucketName}/${a}/stdout.txt`)};var d=require("@aws-sdk/client-sns");var j=new d.SNSClient,P=async(o,t,e,n,r)=>{let s=`CloudWatch Logs: ${n}`;if(r?.type==="cloudWatchLogs")s=`CloudWatch Logs: ${r.logGroupName}`;else if(r?.type==="s3"){let a=r,S=a.prefix?`/${a.prefix}`:"";s=`S3: s3://${a.bucketName}${S}`}let i={version:"1.0",source:"custom",content:{title:"\u{1F512} Image Scanner with Trivy - Vulnerability Alert",description:`Image: ${e}

Scan Logs: ${s}

Details:
${t}`}},u=`Image Scanner with Trivy detected vulnerabilities in ${e}

Scan Logs: ${s}

${t}`,p={default:u,email:u,https:JSON.stringify(i)};try{await j.send(new d.PublishCommand({TopicArn:o,Message:JSON.stringify(p),MessageStructure:"json"})),console.log(`Vulnerability notification sent to SNS topic: ${o}`)}catch(a){console.error(`Failed to send vulnerability notification to SNS: ${a}`)}};var l=require("@aws-sdk/client-cloudformation"),U=new l.CloudFormationClient,G=async o=>{let t=new l.DescribeStacksCommand({StackName:o}),e=await U.send(t);if(e.Stacks&&e.Stacks.length>0){let n=e.Stacks[0].StackStatus;return n===l.ResourceStatus.ROLLBACK_IN_PROGRESS||n===l.ResourceStatus.UPDATE_ROLLBACK_IN_PROGRESS}throw new Error(`Stack not found or no stacks returned from DescribeStacks command, stackId: ${o}`)};var E=async function(o){let t=o.RequestType,e=o.ResourceProperties;if(!e.addr||!e.imageUri)throw new Error("addr and imageUri are required.");let n={PhysicalResourceId:e.addr,Data:{}};if(t!=="Create"&&t!=="Update")return n;e.trivyIgnore.length&&(console.log("trivyignore: "+JSON.stringify(e.trivyIgnore)),R(e.trivyIgnore,e.trivyIgnoreFileType));let r=w(e),s=k(e.imageUri,r);if(await Y(s,e.imageUri,e.exitCode==null,e.output),s.status===0)return n;let i=s.status===1?"vulnerabilities or end-of-life (EOL) image detected":`unexpected exit code ${s.status}`,u=`Error: ${s.error}
Signal: ${s.signal}
Status: ${i}
Image Scanner returned fatal errors. You may have vulnerabilities. See logs.`;if(e.vulnsTopicArn&&await P(e.vulnsTopicArn,u,e.imageUri,e.defaultLogGroupName,e.output),e.failOnVulnerability==="false")return n;if(e.suppressErrorOnRollback==="true"&&await G(o.StackId))return console.log(`Vulnerabilities may be detected, but suppressing errors during rollback (suppressErrorOnRollback=true).
${u}`),n;throw new Error(u)},Y=async(o,t,e,n)=>{switch(n?.type){case"cloudWatchLogs":e?await T(o,n,t):await N(o,n,t);break;case"s3":await v(o,n,t);break;default:console.log(`stderr:
`+o.stderr.toString()),console.log(`stdout:
`+o.stdout.toString())}};0&&(module.exports={handler});
