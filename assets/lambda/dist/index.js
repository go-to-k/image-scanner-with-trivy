"use strict";var d=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var R=(e,o)=>{for(var t in o)d(e,t,{get:o[t],enumerable:!0})},N=(e,o,t,n)=>{if(o&&typeof o=="object"||typeof o=="function")for(let s of $(o))!I.call(e,s)&&s!==t&&d(e,s,{get:()=>o[s],enumerable:!(n=w(o,s))||n.enumerable});return e};var P=e=>N(d({},"__esModule",{value:!0}),e);var U={};R(U,{handler:()=>G});module.exports=P(U);var b=require("child_process"),h=require("fs"),c=require("@aws-sdk/client-cloudwatch-logs"),u=require("@aws-sdk/client-cloudformation"),m=require("@aws-sdk/client-sns"),g=require("@aws-sdk/client-s3");var C="/tmp/.trivyignore",x="/tmp/.trivyignore.yaml",O=new c.CloudWatchLogsClient,T=new u.CloudFormationClient,v=new m.SNSClient,S=new g.S3Client,G=async function(e){let o=e.RequestType,t=e.ResourceProperties;if(!t.addr||!t.imageUri)throw new Error("addr and imageUri are required.");let n={PhysicalResourceId:t.addr,Data:{}};if(o!=="Create"&&o!=="Update")return n;t.trivyIgnore.length&&(console.log("trivyignore: "+JSON.stringify(t.trivyIgnore)),_(t.trivyIgnore,t.trivyIgnoreFileType));let s=t.output?.type==="s3"?t.output.sbomFormat:void 0,i=E(t,s),r=F(t.imageUri,i);if(await B(r,t.imageUri,t.output),r.status===0)return n;let p=r.status===1?"vulnerabilities or end-of-life (EOL) image detected":`unexpected exit code ${r.status}`,l=`Error: ${r.error}
Signal: ${r.signal}
Status: ${p}
Image Scanner returned fatal errors. You may have vulnerabilities. See logs.`;if(t.vulnsTopicArn&&await j(t.vulnsTopicArn,l,t.imageUri),t.failOnVulnerability==="false")return n;if(t.suppressErrorOnRollback==="true"&&await D(e.StackId))return console.log(`Vulnerabilities may be detected, but suppressing errors during rollback (suppressErrorOnRollback=true).
${l}`),n;throw new Error(l)},E=(e,o)=>{let t=[];if(t.push("--no-progress"),o&&t.push(`--format ${o}`),e.ignoreUnfixed==="true"&&t.push("--ignore-unfixed"),e.severity.length&&t.push(`--severity ${e.severity.join(",")}`),e.scanners.length&&t.push(`--scanners ${e.scanners.join(",")}`),e.imageConfigScanners.length&&t.push(`--image-config-scanners ${e.imageConfigScanners.join(",")}`),e.exitCode&&t.push(`--exit-code ${e.exitCode}`),e.exitOnEol&&t.push(`--exit-on-eol ${e.exitOnEol}`),e.exitCode==null&&t.push("--exit-code 1 --exit-on-eol 1"),e.trivyIgnore.length){let n=e.trivyIgnoreFileType==="TRIVYIGNORE_YAML"?x:C;t.push(`--ignorefile ${n}`)}return e.platform&&t.push(`--platform ${e.platform}`),t},F=(e,o)=>{let t=`/opt/trivy image ${o.join(" ")} ${e}`;return console.log("imageUri: "+e),console.log("command: "+t),(0,b.spawnSync)(t,{shell:!0,maxBuffer:50*1024*1024})},_=(e,o)=>{(0,h.writeFileSync)(o==="TRIVYIGNORE_YAML"?x:C,e.join(`
`),"utf-8")},B=async(e,o,t)=>{switch(t?.type){case"cloudWatchLogs":await W(e,t,o);break;case"s3":await A(e,t,o);break;default:console.log(`stderr:
`+e.stderr.toString()),console.log(`stdout:
`+e.stdout.toString())}},W=async(e,o,t)=>{let[n,s]=t.split(":"),i=s?`uri=${n},tag=${s}`:`uri=${n}`;try{await O.send(new c.CreateLogStreamCommand({logGroupName:o.logGroupName,logStreamName:i}))}catch(a){if(a instanceof c.ResourceAlreadyExistsException)console.log(`Log stream ${i} already exists in log group ${o.logGroupName}.`);else throw a}let r=new Date().getTime(),p={logGroupName:o.logGroupName,logStreamName:i,logEvents:[{timestamp:r,message:`stderr:
`+e.stderr.toString()},{timestamp:r,message:`stdout:
`+e.stdout.toString()}]},l=new c.PutLogEventsCommand(p);await O.send(l),console.log(`Scan logs output to the log group: ${o.logGroupName}, log stream: ${i}`)},A=async(e,o,t)=>{let n=new Date().toISOString(),[s,i]=t.split(":"),r=s.replace(/\//g,"_"),p=i?i.replace(/\//g,"_"):"latest",a=`${o.prefix?o.prefix.endsWith("/")?o.prefix:`${o.prefix}/`:""}${r}/${p}/${n}`,L=e.stderr.toString(),f=e.stdout.toString();if(o.sbomFormat){let y=o.sbomFormat==="spdx"?"spdx":"json",k=o.sbomFormat==="spdx"?"text/plain":"application/json";await S.send(new g.PutObjectCommand({Bucket:o.bucketName,Key:`${a}-sbom.${y}`,Body:f,ContentType:k})),console.log(`SBOM output to S3: s3://${o.bucketName}/${a}-sbom.${y}`)}else await Promise.all([S.send(new g.PutObjectCommand({Bucket:o.bucketName,Key:`${a}-stderr.txt`,Body:L,ContentType:"text/plain"})),S.send(new g.PutObjectCommand({Bucket:o.bucketName,Key:`${a}-stdout.txt`,Body:f,ContentType:"text/plain"}))]),console.log(`Scan logs output to S3:
  stderr: s3://${o.bucketName}/${a}-stderr.txt
  stdout: s3://${o.bucketName}/${a}-stdout.txt`)},D=async e=>{let o=new u.DescribeStacksCommand({StackName:e}),t=await T.send(o);if(t.Stacks&&t.Stacks.length>0){let n=t.Stacks[0].StackStatus;return n===u.ResourceStatus.ROLLBACK_IN_PROGRESS||n===u.ResourceStatus.UPDATE_ROLLBACK_IN_PROGRESS}throw new Error(`Stack not found or no stacks returned from DescribeStacks command, stackId: ${e}`)},j=async(e,o,t)=>{let n={version:"1.0",source:"custom",content:{title:"\u{1F512} Image Scanner with Trivy - Vulnerability Alert",description:`Image: ${t}

Details:
${o}`}},s=`Image Scanner with Trivy detected vulnerabilities in ${t}

${o}`,i={default:s,email:s,https:JSON.stringify(n)};try{await v.send(new m.PublishCommand({TopicArn:e,Message:JSON.stringify(i),MessageStructure:"json"})),console.log(`Vulnerability notification sent to SNS topic: ${e}`)}catch(r){console.error(`Failed to send vulnerability notification to SNS: ${r}`)}};0&&(module.exports={handler});
