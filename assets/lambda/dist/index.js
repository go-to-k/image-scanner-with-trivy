"use strict";var m=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var L=Object.prototype.hasOwnProperty;var w=(t,o)=>{for(var e in o)m(t,e,{get:o[e],enumerable:!0})},I=(t,o,e,n)=>{if(o&&typeof o=="object"||typeof o=="function")for(let r of O(o))!L.call(t,r)&&r!==e&&m(t,r,{get:()=>o[r],enumerable:!(n=C(o,r))||n.enumerable});return t};var R=t=>I(m({},"__esModule",{value:!0}),t);var P={};w(P,{handler:()=>$});module.exports=R(P);var S=require("child_process"),f=require("fs"),a=require("@aws-sdk/client-cloudwatch-logs"),c=require("@aws-sdk/client-cloudformation"),g=require("@aws-sdk/client-sns");var y="/tmp/.trivyignore",h="/tmp/.trivyignore.yaml",d=new a.CloudWatchLogsClient,b=new c.CloudFormationClient,G=new g.SNSClient,$=async function(t){let o=t.RequestType,e=t.ResourceProperties;if(!e.addr||!e.imageUri)throw new Error("addr and imageUri are required.");let n={PhysicalResourceId:e.addr,Data:{}};if(o!=="Create"&&o!=="Update")return n;let r=v(e);e.trivyIgnore.length&&(console.log("trivyignore: "+JSON.stringify(e.trivyIgnore)),T(e.trivyIgnore,e.trivyIgnoreFileType));let i=`/opt/trivy image --no-progress ${r.join(" ")} ${e.imageUri}`;console.log("command: "+i),console.log("imageUri: "+e.imageUri);let s=(0,S.spawnSync)(i,{shell:!0});if(await x(s,e.imageUri,e.output),s.status===0)return n;let u=s.status===1?"vulnerabilities or end-of-life (EOL) image detected":`unexpected exit code ${s.status}`,l=`Error: ${s.error}
Signal: ${s.signal}
Status: ${u}
Image Scanner returned fatal errors. You may have vulnerabilities. See logs.`;if(e.vulnsTopicArn&&await E(e.vulnsTopicArn,l,e.imageUri),!e.failOnVulnerability)return n;if(e.suppressErrorOnRollback==="true"&&await k(t.StackId))return console.log(`Vulnerabilities may be detected, but suppressing errors during rollback (suppressErrorOnRollback=true).
${l}`),n;throw new Error(l)},v=t=>{let o=[];if(t.ignoreUnfixed==="true"&&o.push("--ignore-unfixed"),t.severity.length&&o.push(`--severity ${t.severity.join(",")}`),t.scanners.length&&o.push(`--scanners ${t.scanners.join(",")}`),t.imageConfigScanners.length&&o.push(`--image-config-scanners ${t.imageConfigScanners.join(",")}`),t.exitCode&&o.push(`--exit-code ${t.exitCode}`),t.exitOnEol&&o.push(`--exit-on-eol ${t.exitOnEol}`),t.exitCode==null&&o.push("--exit-code 1 --exit-on-eol 1"),t.trivyIgnore.length){let e=t.trivyIgnoreFileType==="TRIVYIGNORE_YAML"?h:y;o.push(`--ignorefile ${e}`)}return t.platform&&o.push(`--platform ${t.platform}`),o},T=(t,o)=>{(0,f.writeFileSync)(o==="TRIVYIGNORE_YAML"?h:y,t.join(`
`),"utf-8")},x=async(t,o,e)=>{switch(e?.type){case"cloudWatchLogs":await N(t,e,o);break;default:console.log(`stderr:
`+t.stderr.toString()),console.log(`stdout:
`+t.stdout.toString())}},N=async(t,o,e)=>{let[n,r]=e.split(":"),i=r?`uri=${n},tag=${r}`:`uri=${n}`;try{await d.send(new a.CreateLogStreamCommand({logGroupName:o.logGroupName,logStreamName:i}))}catch(p){if(p instanceof a.ResourceAlreadyExistsException)console.log(`Log stream ${i} already exists in log group ${o.logGroupName}.`);else throw p}let s=new Date().getTime(),u={logGroupName:o.logGroupName,logStreamName:i,logEvents:[{timestamp:s,message:`stderr:
`+t.stderr.toString()},{timestamp:s,message:`stdout:
`+t.stdout.toString()}]},l=new a.PutLogEventsCommand(u);await d.send(l),console.log(`Scan logs output to the log group: ${o.logGroupName}, log stream: ${i}`)},k=async t=>{let o=new c.DescribeStacksCommand({StackName:t}),e=await b.send(o);if(e.Stacks&&e.Stacks.length>0){let n=e.Stacks[0].StackStatus;return n===c.ResourceStatus.ROLLBACK_IN_PROGRESS||n===c.ResourceStatus.UPDATE_ROLLBACK_IN_PROGRESS}throw new Error(`Stack not found or no stacks returned from DescribeStacks command, stackId: ${t}`)},E=async(t,o,e)=>{let n={version:"1.0",source:"custom",content:{title:"\u{1F512} Image Scanner with Trivy - Vulnerability Alert",description:`Image: ${e}

Details:
${o}`}},r=`Image Scanner with Trivy - Vulnerability Alert - ${e}`,i=`Image Scanner with Trivy detected vulnerabilities in ${e}

${o}`,s={default:i,email:i,https:JSON.stringify(n)};try{await G.send(new g.PublishCommand({TopicArn:t,Subject:r,Message:JSON.stringify(s),MessageStructure:"json"})),console.log(`Vulnerability notification sent to SNS topic: ${t}`)}catch(u){console.error(`Failed to send vulnerability notification to SNS: ${u}`)}};0&&(module.exports={handler});
