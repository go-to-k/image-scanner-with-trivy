"use strict";var m=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var w=Object.prototype.hasOwnProperty;var I=(t,e)=>{for(var n in e)m(t,n,{get:e[n],enumerable:!0})},$=(t,e,n,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of k(e))!w.call(t,r)&&r!==n&&m(t,r,{get:()=>e[r],enumerable:!(o=L(e,r))||o.enumerable});return t};var R=t=>$(m({},"__esModule",{value:!0}),t);var U={};I(U,{handler:()=>v});module.exports=R(U);var y=require("child_process"),O=require("fs"),a=require("@aws-sdk/client-cloudwatch-logs"),u=require("@aws-sdk/client-cloudformation"),d=require("@aws-sdk/client-sns"),p=require("@aws-sdk/client-s3");var h="/tmp/.trivyignore",C="/tmp/.trivyignore.yaml",S=new a.CloudWatchLogsClient,N=new u.CloudFormationClient,G=new d.SNSClient,f=new p.S3Client,v=async function(t){let e=t.RequestType,n=t.ResourceProperties;if(!n.addr||!n.imageUri)throw new Error("addr and imageUri are required.");let o={PhysicalResourceId:n.addr,Data:{}};if(e!=="Create"&&e!=="Update")return o;let r=T(n);n.trivyIgnore.length&&(console.log("trivyignore: "+JSON.stringify(n.trivyIgnore)),P(n.trivyIgnore,n.trivyIgnoreFileType));let i=`/opt/trivy image --no-progress ${r.join(" ")} ${n.imageUri}`;console.log("command: "+i),console.log("imageUri: "+n.imageUri);let s=(0,y.spawnSync)(i,{shell:!0});if(await E(s,n.imageUri,n.output),s.status===0)return o;let g=s.status===1?"vulnerabilities or end-of-life (EOL) image detected":`unexpected exit code ${s.status}`,l=`Error: ${s.error}
Signal: ${s.signal}
Status: ${g}
Image Scanner returned fatal errors. You may have vulnerabilities. See logs.`;if(n.vulnsTopicArn&&await B(n.vulnsTopicArn,l,n.imageUri),n.failOnVulnerability==="false")return o;if(n.suppressErrorOnRollback==="true"&&await A(t.StackId))return console.log(`Vulnerabilities may be detected, but suppressing errors during rollback (suppressErrorOnRollback=true).
${l}`),o;throw new Error(l)},T=t=>{let e=[];if(t.ignoreUnfixed==="true"&&e.push("--ignore-unfixed"),t.severity.length&&e.push(`--severity ${t.severity.join(",")}`),t.scanners.length&&e.push(`--scanners ${t.scanners.join(",")}`),t.imageConfigScanners.length&&e.push(`--image-config-scanners ${t.imageConfigScanners.join(",")}`),t.exitCode&&e.push(`--exit-code ${t.exitCode}`),t.exitOnEol&&e.push(`--exit-on-eol ${t.exitOnEol}`),t.exitCode==null&&e.push("--exit-code 1 --exit-on-eol 1"),t.trivyIgnore.length){let n=t.trivyIgnoreFileType==="TRIVYIGNORE_YAML"?C:h;e.push(`--ignorefile ${n}`)}return t.platform&&e.push(`--platform ${t.platform}`),e},P=(t,e)=>{(0,O.writeFileSync)(e==="TRIVYIGNORE_YAML"?C:h,t.join(`
`),"utf-8")},E=async(t,e,n)=>{switch(n?.type){case"cloudWatchLogs":await _(t,n,e);break;case"s3":await W(t,n,e);break;default:console.log(`stderr:
`+t.stderr.toString()),console.log(`stdout:
`+t.stdout.toString())}},_=async(t,e,n)=>{let[o,r]=n.split(":"),i=r?`uri=${o},tag=${r}`:`uri=${o}`;try{await S.send(new a.CreateLogStreamCommand({logGroupName:e.logGroupName,logStreamName:i}))}catch(c){if(c instanceof a.ResourceAlreadyExistsException)console.log(`Log stream ${i} already exists in log group ${e.logGroupName}.`);else throw c}let s=new Date().getTime(),g={logGroupName:e.logGroupName,logStreamName:i,logEvents:[{timestamp:s,message:`stderr:
`+t.stderr.toString()},{timestamp:s,message:`stdout:
`+t.stdout.toString()}]},l=new a.PutLogEventsCommand(g);await S.send(l),console.log(`Scan logs output to the log group: ${e.logGroupName}, log stream: ${i}`)},W=async(t,e,n)=>{let o=new Date().toISOString(),[r,i]=n.split(":"),s=r.replace(/\//g,"_"),g=i?i.replace(/\//g,"_"):"latest",c=`${e.prefix?e.prefix.endsWith("/")?e.prefix:`${e.prefix}/`:""}${s}/${g}/${o}`,b=t.stderr.toString(),x=t.stdout.toString();await Promise.all([f.send(new p.PutObjectCommand({Bucket:e.bucketName,Key:`${c}/stderr.txt`,Body:b,ContentType:"text/plain"})),f.send(new p.PutObjectCommand({Bucket:e.bucketName,Key:`${c}/stdout.txt`,Body:x,ContentType:"text/plain"}))]),console.log(`Scan logs output to S3:
  stderr: s3://${e.bucketName}/${c}/stderr.txt
  stdout: s3://${e.bucketName}/${c}/stdout.txt`)},A=async t=>{let e=new u.DescribeStacksCommand({StackName:t}),n=await N.send(e);if(n.Stacks&&n.Stacks.length>0){let o=n.Stacks[0].StackStatus;return o===u.ResourceStatus.ROLLBACK_IN_PROGRESS||o===u.ResourceStatus.UPDATE_ROLLBACK_IN_PROGRESS}throw new Error(`Stack not found or no stacks returned from DescribeStacks command, stackId: ${t}`)},B=async(t,e,n)=>{let o={version:"1.0",source:"custom",content:{title:"\u{1F512} Image Scanner with Trivy - Vulnerability Alert",description:`Image: ${n}

Details:
${e}`}},r=`Image Scanner with Trivy detected vulnerabilities in ${n}

${e}`,i={default:r,email:r,https:JSON.stringify(o)};try{await G.send(new d.PublishCommand({TopicArn:t,Message:JSON.stringify(i),MessageStructure:"json"})),console.log(`Vulnerability notification sent to SNS topic: ${t}`)}catch(s){console.error(`Failed to send vulnerability notification to SNS: ${s}`)}};0&&(module.exports={handler});
