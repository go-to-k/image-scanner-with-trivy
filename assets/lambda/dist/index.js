"use strict";var l=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var C=Object.prototype.hasOwnProperty;var h=(t,e)=>{for(var o in e)l(t,o,{get:e[o],enumerable:!0})},R=(t,e,o,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of O(e))!C.call(t,r)&&r!==o&&l(t,r,{get:()=>e[r],enumerable:!(n=L(e,r))||n.enumerable});return t};var I=t=>R(l({},"__esModule",{value:!0}),t);var N={};h(N,{handler:()=>w});module.exports=I(N);var d=require("child_process"),f=require("fs"),a=require("@aws-sdk/client-cloudwatch-logs"),u=require("@aws-sdk/client-cloudformation");var S="/tmp/.trivyignore",y="/tmp/.trivyignore.yaml",m=new a.CloudWatchLogsClient,G=new u.CloudFormationClient,w=async function(t){let e=t.RequestType,o=t.ResourceProperties;if(!o.addr||!o.imageUri)throw new Error("addr and imageUri are required.");let n={PhysicalResourceId:o.addr,Data:{}};if(e!=="Create"&&e!=="Update")return n;let r=b(o);o.trivyIgnore.length&&(console.log("trivyignore: "+JSON.stringify(o.trivyIgnore)),k(o.trivyIgnore,o.trivyIgnoreFileType));let i=`/opt/trivy image --no-progress ${r.join(" ")} --exit-code 1 --exit-on-eol 1 ${o.imageUri}`;console.log("command: "+i),console.log("imageUri: "+o.imageUri);let s=(0,d.spawnSync)(i,{shell:!0});if(await v(s,o.imageUri,o.output),s.status===0||(o.vulnsTopicArn&&T(o.vulnsTopicArn),s.status===1&&!o.failOnVulnerability))return n;let g=s.status===1?"vulnerabilities or end-of-life (EOL) image detected":`unexpected exit code ${s.status}`,c=`Error: ${s.error}
Signal: ${s.signal}
Status: ${g}
Image Scanner returned fatal errors. You may have vulnerabilities. See logs.`;if(o.suppressErrorOnRollback==="true"&&await P(t.StackId))return console.log(`Vulnerabilities may be detected, but suppressing errors during rollback (suppressErrorOnRollback=true).
${c}`),n;throw new Error(c)},b=t=>{let e=[];if(t.ignoreUnfixed==="true"&&e.push("--ignore-unfixed"),t.severity.length&&e.push(`--severity ${t.severity.join(",")}`),t.scanners.length&&e.push(`--scanners ${t.scanners.join(",")}`),t.imageConfigScanners.length&&e.push(`--image-config-scanners ${t.imageConfigScanners.join(",")}`),t.trivyIgnore.length){let o=t.trivyIgnoreFileType==="TRIVYIGNORE_YAML"?y:S;e.push(`--ignorefile ${o}`)}return t.platform&&e.push(`--platform ${t.platform}`),e},k=(t,e)=>{(0,f.writeFileSync)(e==="TRIVYIGNORE_YAML"?y:S,t.join(`
`),"utf-8")},v=async(t,e,o)=>{switch(o?.type){case"cloudWatchLogs":await E(t,o,e);break;default:console.log(`stderr:
`+t.stderr.toString()),console.log(`stdout:
`+t.stdout.toString())}},E=async(t,e,o)=>{let[n,r]=o.split(":"),i=r?`uri=${n},tag=${r}`:`uri=${n}`;try{await m.send(new a.CreateLogStreamCommand({logGroupName:e.logGroupName,logStreamName:i}))}catch(p){if(p instanceof a.ResourceAlreadyExistsException)console.log(`Log stream ${i} already exists in log group ${e.logGroupName}.`);else throw p}let s=new Date().getTime(),g={logGroupName:e.logGroupName,logStreamName:i,logEvents:[{timestamp:s,message:`stderr:
`+t.stderr.toString()},{timestamp:s,message:`stdout:
`+t.stdout.toString()}]},c=new a.PutLogEventsCommand(g);await m.send(c),console.log(`Scan logs output to the log group: ${e.logGroupName}, log stream: ${i}`)},P=async t=>{let e=new u.DescribeStacksCommand({StackName:t}),o=await G.send(e);if(o.Stacks&&o.Stacks.length>0){let n=o.Stacks[0].StackStatus;return n===u.ResourceStatus.ROLLBACK_IN_PROGRESS||n===u.ResourceStatus.UPDATE_ROLLBACK_IN_PROGRESS}throw new Error(`Stack not found or no stacks returned from DescribeStacks command, stackId: ${t}`)},T=async t=>{};0&&(module.exports={handler});
