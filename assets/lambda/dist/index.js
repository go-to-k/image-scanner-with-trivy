"use strict";var m=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var L=Object.prototype.hasOwnProperty;var R=(t,e)=>{for(var o in e)m(t,o,{get:e[o],enumerable:!0})},w=(t,e,o,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of O(e))!L.call(t,r)&&r!==o&&m(t,r,{get:()=>e[r],enumerable:!(n=C(e,r))||n.enumerable});return t};var I=t=>w(m({},"__esModule",{value:!0}),t);var P={};R(P,{handler:()=>$});module.exports=I(P);var f=require("child_process"),S=require("fs"),a=require("@aws-sdk/client-cloudwatch-logs"),u=require("@aws-sdk/client-cloudformation"),l=require("@aws-sdk/client-sns");var y="/tmp/.trivyignore",h="/tmp/.trivyignore.yaml",d=new a.CloudWatchLogsClient,b=new u.CloudFormationClient,G=new l.SNSClient,$=async function(t){let e=t.RequestType,o=t.ResourceProperties;if(!o.addr||!o.imageUri)throw new Error("addr and imageUri are required.");let n={PhysicalResourceId:o.addr,Data:{}};if(e!=="Create"&&e!=="Update")return n;let r=v(o);o.trivyIgnore.length&&(console.log("trivyignore: "+JSON.stringify(o.trivyIgnore)),x(o.trivyIgnore,o.trivyIgnoreFileType));let i=`/opt/trivy image --no-progress ${r.join(" ")} ${o.imageUri}`;console.log("command: "+i),console.log("imageUri: "+o.imageUri);let s=(0,f.spawnSync)(i,{shell:!0});if(await N(s,o.imageUri,o.output),s.status===0)return n;let g=s.status===1?"vulnerabilities or end-of-life (EOL) image detected":`unexpected exit code ${s.status}`,c=`Error: ${s.error}
Signal: ${s.signal}
Status: ${g}
Image Scanner returned fatal errors. You may have vulnerabilities. See logs.`;if(o.vulnsTopicArn&&await E(o.vulnsTopicArn,c,o.imageUri),o.failOnVulnerability==="false")return n;if(o.suppressErrorOnRollback==="true"&&await k(t.StackId))return console.log(`Vulnerabilities may be detected, but suppressing errors during rollback (suppressErrorOnRollback=true).
${c}`),n;throw new Error(c)},v=t=>{let e=[];if(t.ignoreUnfixed==="true"&&e.push("--ignore-unfixed"),t.severity.length&&e.push(`--severity ${t.severity.join(",")}`),t.scanners.length&&e.push(`--scanners ${t.scanners.join(",")}`),t.imageConfigScanners.length&&e.push(`--image-config-scanners ${t.imageConfigScanners.join(",")}`),t.exitCode&&e.push(`--exit-code ${t.exitCode}`),t.exitOnEol&&e.push(`--exit-on-eol ${t.exitOnEol}`),t.exitCode==null&&e.push("--exit-code 1 --exit-on-eol 1"),t.trivyIgnore.length){let o=t.trivyIgnoreFileType==="TRIVYIGNORE_YAML"?h:y;e.push(`--ignorefile ${o}`)}return t.platform&&e.push(`--platform ${t.platform}`),e},x=(t,e)=>{(0,S.writeFileSync)(e==="TRIVYIGNORE_YAML"?h:y,t.join(`
`),"utf-8")},N=async(t,e,o)=>{switch(o?.type){case"cloudWatchLogs":await T(t,o,e);break;default:console.log(`stderr:
`+t.stderr.toString()),console.log(`stdout:
`+t.stdout.toString())}},T=async(t,e,o)=>{let[n,r]=o.split(":"),i=r?`uri=${n},tag=${r}`:`uri=${n}`;try{await d.send(new a.CreateLogStreamCommand({logGroupName:e.logGroupName,logStreamName:i}))}catch(p){if(p instanceof a.ResourceAlreadyExistsException)console.log(`Log stream ${i} already exists in log group ${e.logGroupName}.`);else throw p}let s=new Date().getTime(),g={logGroupName:e.logGroupName,logStreamName:i,logEvents:[{timestamp:s,message:`stderr:
`+t.stderr.toString()},{timestamp:s,message:`stdout:
`+t.stdout.toString()}]},c=new a.PutLogEventsCommand(g);await d.send(c),console.log(`Scan logs output to the log group: ${e.logGroupName}, log stream: ${i}`)},k=async t=>{let e=new u.DescribeStacksCommand({StackName:t}),o=await b.send(e);if(o.Stacks&&o.Stacks.length>0){let n=o.Stacks[0].StackStatus;return n===u.ResourceStatus.ROLLBACK_IN_PROGRESS||n===u.ResourceStatus.UPDATE_ROLLBACK_IN_PROGRESS}throw new Error(`Stack not found or no stacks returned from DescribeStacks command, stackId: ${t}`)},E=async(t,e,o)=>{let n={version:"1.0",source:"custom",content:{title:"\u{1F512} Image Scanner with Trivy - Vulnerability Alert",description:`Image: ${o}

Details:
${e}`}},r=`Image Scanner with Trivy detected vulnerabilities in ${o}

${e}`,i={default:r,email:r,https:JSON.stringify(n)};try{await G.send(new l.PublishCommand({TopicArn:t,Message:JSON.stringify(i),MessageStructure:"json"})),console.log(`Vulnerability notification sent to SNS topic: ${t}`)}catch(s){console.error(`Failed to send vulnerability notification to SNS: ${s}`)}};0&&(module.exports={handler});
