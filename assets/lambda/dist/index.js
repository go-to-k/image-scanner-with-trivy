"use strict";var f=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var R=(e,t)=>{for(var o in t)f(e,o,{get:t[o],enumerable:!0})},G=(e,t,o,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of N(t))!I.call(e,r)&&r!==o&&f(e,r,{get:()=>t[r],enumerable:!(n=k(t,r))||n.enumerable});return e};var T=e=>G(f({},"__esModule",{value:!0}),e);var Y={};R(Y,{handler:()=>E});module.exports=T(Y);var L=require("child_process"),h=require("fs"),u=require("@aws-sdk/client-cloudwatch-logs"),g=require("@aws-sdk/client-cloudformation"),d=require("@aws-sdk/client-sns"),p=require("@aws-sdk/client-s3");var x="/tmp/.trivyignore",$="/tmp/.trivyignore.yaml",m=new u.CloudWatchLogsClient,v=new g.CloudFormationClient,P=new d.SNSClient,y=new p.S3Client,E=async function(e){let t=e.RequestType,o=e.ResourceProperties;if(!o.addr||!o.imageUri)throw new Error("addr and imageUri are required.");let n={PhysicalResourceId:o.addr,Data:{}};if(t!=="Create"&&t!=="Update")return n;o.trivyIgnore.length&&(console.log("trivyignore: "+JSON.stringify(o.trivyIgnore)),_(o.trivyIgnore,o.trivyIgnoreFileType));let r=W(o),s=F(o.imageUri,r);if(await B(s,o.imageUri,o.exitCode==null,o.output),s.status===0)return n;let i=s.status===1?"vulnerabilities or end-of-life (EOL) image detected":`unexpected exit code ${s.status}`,c=`Error: ${s.error}
Signal: ${s.signal}
Status: ${i}
Image Scanner returned fatal errors. You may have vulnerabilities. See logs.`;if(o.vulnsTopicArn&&await V(o.vulnsTopicArn,c,o.imageUri,o.defaultLogGroupName,o.output),o.failOnVulnerability==="false")return n;if(o.suppressErrorOnRollback==="true"&&await U(e.StackId))return console.log(`Vulnerabilities may be detected, but suppressing errors during rollback (suppressErrorOnRollback=true).
${c}`),n;throw new Error(c)},W=e=>{let t=[];t.push("--no-progress");let o=e.output?.type==="s3"?e.output.sbomFormat:void 0;if(o&&t.push(`--format ${o}`),e.ignoreUnfixed==="true"&&t.push("--ignore-unfixed"),e.severity.length&&t.push(`--severity ${e.severity.join(",")}`),e.scanners.length&&t.push(`--scanners ${e.scanners.join(",")}`),e.imageConfigScanners.length&&t.push(`--image-config-scanners ${e.imageConfigScanners.join(",")}`),e.exitCode&&t.push(`--exit-code ${e.exitCode}`),e.exitOnEol&&t.push(`--exit-on-eol ${e.exitOnEol}`),e.exitCode==null&&t.push("--exit-code 1 --exit-on-eol 1"),e.trivyIgnore.length){let n=e.trivyIgnoreFileType==="TRIVYIGNORE_YAML"?$:x;t.push(`--ignorefile ${n}`)}return e.platform&&t.push(`--platform ${e.platform}`),t},F=(e,t)=>{let o=`/opt/trivy image ${t.join(" ")} ${e}`;return console.log("imageUri: "+e),console.log("command: "+o),(0,L.spawnSync)(o,{shell:!0,maxBuffer:50*1024*1024})},_=(e,t)=>{(0,h.writeFileSync)(t==="TRIVYIGNORE_YAML"?$:x,e.join(`
`),"utf-8")},B=async(e,t,o,n)=>{switch(n?.type){case"cloudWatchLogs":o?await D(e,n,t):await A(e,n,t);break;case"s3":await j(e,n,t);break;default:console.log(`stderr:
`+e.stderr.toString()),console.log(`stdout:
`+e.stdout.toString())}},A=async(e,t,o)=>{let[n,r]=o.split(":"),s=r?`uri=${n},tag=${r}`:`uri=${n}`;try{await m.send(new u.CreateLogStreamCommand({logGroupName:t.logGroupName,logStreamName:s}))}catch(a){if(a instanceof u.ResourceAlreadyExistsException)console.log(`Log stream ${s} already exists in log group ${t.logGroupName}.`);else throw a}let i=new Date().getTime(),c={logGroupName:t.logGroupName,logStreamName:s,logEvents:[{timestamp:i,message:`stderr:
`+e.stderr.toString()},{timestamp:i,message:`stdout:
`+e.stdout.toString()}]},l=new u.PutLogEventsCommand(c);await m.send(l),console.log(`Scan logs output to the log group: ${t.logGroupName}, log stream: ${s}`)},D=async(e,t,o)=>{let[n,r]=o.split(":"),s=r?`uri=${n},tag=${r}`:`uri=${n}`,i=`${s}/stdout`,c=`${s}/stderr`,l=new Date().getTime();await C(t.logGroupName,i,l,e.stdout.toString()),await C(t.logGroupName,c,l,e.stderr.toString()),console.log(`Scan logs output to the log group: ${t.logGroupName}
  stdout stream: ${i}
  stderr stream: ${c}`)},C=async(e,t,o,n)=>{try{await m.send(new u.CreateLogStreamCommand({logGroupName:e,logStreamName:t}))}catch(i){if(i instanceof u.ResourceAlreadyExistsException)console.log(`Log stream ${t} already exists in log group ${e}.`);else throw i}let r={logGroupName:e,logStreamName:t,logEvents:[{timestamp:o,message:n}]},s=new u.PutLogEventsCommand(r);await m.send(s)},j=async(e,t,o)=>{let n=new Date().toISOString(),[r,s]=o.split(":"),i=r.replace(/\//g,"_"),c=s?s.replace(/\//g,"_"):"latest",a=`${t.prefix?t.prefix.endsWith("/")?t.prefix:`${t.prefix}/`:""}${i}/${c}/${n}`,S=e.stderr.toString(),O=e.stdout.toString();if(t.sbomFormat){let b=t.sbomFormat==="spdx"?"spdx":"json",w=t.sbomFormat==="spdx"?"text/plain":"application/json";await y.send(new p.PutObjectCommand({Bucket:t.bucketName,Key:`${a}/sbom.${b}`,Body:O,ContentType:w})),console.log(`SBOM output to S3: s3://${t.bucketName}/${a}/sbom.${b}`)}else await Promise.all([y.send(new p.PutObjectCommand({Bucket:t.bucketName,Key:`${a}/stderr.txt`,Body:S,ContentType:"text/plain"})),y.send(new p.PutObjectCommand({Bucket:t.bucketName,Key:`${a}/stdout.txt`,Body:O,ContentType:"text/plain"}))]),console.log(`Scan logs output to S3:
  stderr: s3://${t.bucketName}/${a}/stderr.txt
  stdout: s3://${t.bucketName}/${a}/stdout.txt`)},U=async e=>{let t=new g.DescribeStacksCommand({StackName:e}),o=await v.send(t);if(o.Stacks&&o.Stacks.length>0){let n=o.Stacks[0].StackStatus;return n===g.ResourceStatus.ROLLBACK_IN_PROGRESS||n===g.ResourceStatus.UPDATE_ROLLBACK_IN_PROGRESS}throw new Error(`Stack not found or no stacks returned from DescribeStacks command, stackId: ${e}`)},V=async(e,t,o,n,r)=>{let s=`CloudWatch Logs: ${n}`;if(r?.type==="cloudWatchLogs")s=`CloudWatch Logs: ${r.logGroupName}`;else if(r?.type==="s3"){let a=r,S=a.prefix?`/${a.prefix}`:"";s=`S3: s3://${a.bucketName}${S}`}let i={version:"1.0",source:"custom",content:{title:"\u{1F512} Image Scanner with Trivy - Vulnerability Alert",description:`Image: ${o}

Scan Logs: ${s}

Details:
${t}`}},c=`Image Scanner with Trivy detected vulnerabilities in ${o}

Scan Logs: ${s}

${t}`,l={default:c,email:c,https:JSON.stringify(i)};try{await P.send(new d.PublishCommand({TopicArn:e,Message:JSON.stringify(l),MessageStructure:"json"})),console.log(`Vulnerability notification sent to SNS topic: ${e}`)}catch(a){console.error(`Failed to send vulnerability notification to SNS: ${a}`)}};0&&(module.exports={handler});
