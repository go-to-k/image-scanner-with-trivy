"use strict";var g=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var L=Object.prototype.hasOwnProperty;var h=(t,o)=>{for(var e in o)g(t,e,{get:o[e],enumerable:!0})},R=(t,o,e,n)=>{if(o&&typeof o=="object"||typeof o=="function")for(let r of O(o))!L.call(t,r)&&r!==e&&g(t,r,{get:()=>o[r],enumerable:!(n=C(o,r))||n.enumerable});return t};var I=t=>R(g({},"__esModule",{value:!0}),t);var v={};h(v,{handler:()=>w});module.exports=I(v);var p=require("child_process"),d=require("fs"),a=require("@aws-sdk/client-cloudwatch-logs"),u=require("@aws-sdk/client-cloudformation");var S="/tmp/.trivyignore",f="/tmp/.trivyignore.yaml",m=new a.CloudWatchLogsClient,G=new u.CloudFormationClient,w=async function(t){let o=t.RequestType,e=t.ResourceProperties;if(!e.addr||!e.imageUri)throw new Error("addr and imageUri are required.");let n={PhysicalResourceId:e.addr,Data:{}};if(o==="Create"||o==="Update"){let r=k(e);e.trivyIgnore.length&&(console.log("trivyignore: "+JSON.stringify(e.trivyIgnore)),E(e.trivyIgnore,e.trivyIgnoreFileType));let i=`/opt/trivy image --no-progress ${r.join(" ")} ${e.imageUri}`;console.log("command: "+i),console.log("imageUri: "+e.imageUri);let s=(0,p.spawnSync)(i,{shell:!0});if(await b(s,e.imageUri,e.output),s.status===0)return n;let c=`Error: ${s.error}
Signal: ${s.signal}
Status: ${s.status}
Image Scanner returned fatal errors. You may have vulnerabilities. See logs.`;if(e.suppressErrorOnRollback==="true"&&await $(t.StackId))return console.log(`Vulnerabilities may be detected, but suppressing errors during rollback (suppressErrorOnRollback=true).
${c}`),n;throw new Error(c)}return n},k=t=>{let o=[];if(t.ignoreUnfixed==="true"&&o.push("--ignore-unfixed"),t.severity.length&&o.push(`--severity ${t.severity.join(",")}`),t.scanners.length&&o.push(`--scanners ${t.scanners.join(",")}`),t.imageConfigScanners.length&&o.push(`--image-config-scanners ${t.imageConfigScanners.join(",")}`),t.exitCode&&o.push(`--exit-code ${t.exitCode}`),t.exitOnEol&&o.push(`--exit-on-eol ${t.exitOnEol}`),t.trivyIgnore.length){let e=t.trivyIgnoreFileType==="TRIVYIGNORE_YAML"?f:S;o.push(`--ignorefile ${e}`)}return t.platform&&o.push(`--platform ${t.platform}`),o},E=(t,o)=>{(0,d.writeFileSync)(o==="TRIVYIGNORE_YAML"?f:S,t.join(`
`),"utf-8")},b=async(t,o,e)=>{switch(e?.type){case"cloudWatchLogs":await P(t,e,o);break;default:console.log(`stderr:
`+t.stderr.toString()),console.log(`stdout:
`+t.stdout.toString())}},P=async(t,o,e)=>{let[n,r]=e.split(":"),i=r?`uri=${n},tag=${r}`:`uri=${n}`;try{await m.send(new a.CreateLogStreamCommand({logGroupName:o.logGroupName,logStreamName:i}))}catch(l){if(l instanceof a.ResourceAlreadyExistsException)console.log(`Log stream ${i} already exists in log group ${o.logGroupName}.`);else throw l}let s=new Date().getTime(),c={logGroupName:o.logGroupName,logStreamName:i,logEvents:[{timestamp:s,message:`stderr:
`+t.stderr.toString()},{timestamp:s,message:`stdout:
`+t.stdout.toString()}]},y=new a.PutLogEventsCommand(c);await m.send(y),console.log(`Scan logs output to the log group: ${o.logGroupName}, log stream: ${i}`)},$=async t=>{let o=new u.DescribeStacksCommand({StackName:t}),e=await G.send(o);if(e.Stacks&&e.Stacks.length>0){let n=e.Stacks[0].StackStatus;return n===u.ResourceStatus.ROLLBACK_IN_PROGRESS||n===u.ResourceStatus.UPDATE_ROLLBACK_IN_PROGRESS}throw new Error(`Stack not found or no stacks returned from DescribeStacks command, stackId: ${t}`)};0&&(module.exports={handler});
