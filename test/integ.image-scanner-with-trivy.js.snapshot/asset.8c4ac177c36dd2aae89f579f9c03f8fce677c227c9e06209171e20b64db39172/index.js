"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const child_process_1 = require("child_process");
const fs_1 = require("fs");
const client_cloudwatch_logs_1 = require("@aws-sdk/client-cloudwatch-logs");
const types_1 = require("../../src/types");
const TRIVY_IGNORE_FILE_PATH = '/tmp/.trivyignore';
const cwClient = new client_cloudwatch_logs_1.CloudWatchLogsClient();
const handler = async function (event) {
    const requestType = event.RequestType;
    const props = event.ResourceProperties;
    if (!props.addr || !props.imageUri)
        throw new Error('addr and imageUri are required.');
    const funcResponse = {
        PhysicalResourceId: props.addr,
        Data: {},
    };
    if (requestType === 'Create' || requestType === 'Update') {
        const options = makeOptions(props);
        if (props.trivyIgnore.length) {
            console.log('trivyignore: ' + JSON.stringify(props.trivyIgnore));
            makeTrivyIgnoreFile(props.trivyIgnore);
        }
        const cmd = `/opt/trivy image --no-progress ${options.join(' ')} ${props.imageUri}`;
        console.log('command: ' + cmd);
        console.log('imageUri: ' + props.imageUri);
        const response = (0, child_process_1.spawnSync)(cmd, {
            shell: true,
        });
        await outputScanLogs(response, props.imageUri, props.output);
        if (response.status !== 0)
            throw new Error(`Error: ${response.error}\nSignal: ${response.signal}\nStatus: ${response.status}\nImage Scanner returned fatal errors. You may have vulnerabilities. See logs.`);
    }
    return funcResponse;
};
exports.handler = handler;
const makeOptions = (props) => {
    const options = [];
    if (props.ignoreUnfixed === 'true')
        options.push('--ignore-unfixed');
    if (props.severity.length)
        options.push(`--severity ${props.severity.join(',')}`);
    if (props.scanners.length)
        options.push(`--scanners ${props.scanners.join(',')}`);
    if (props.imageConfigScanners.length)
        options.push(`--image-config-scanners ${props.imageConfigScanners.join(',')}`);
    if (props.exitCode)
        options.push(`--exit-code ${props.exitCode}`);
    if (props.exitOnEol)
        options.push(`--exit-on-eol ${props.exitOnEol}`);
    if (props.trivyIgnore.length)
        options.push(`--ignorefile ${TRIVY_IGNORE_FILE_PATH}`);
    if (props.platform)
        options.push(`--platform ${props.platform}`);
    return options;
};
const makeTrivyIgnoreFile = (trivyIgnore) => {
    const ignoreLines = trivyIgnore.join('\n');
    (0, fs_1.writeFileSync)(TRIVY_IGNORE_FILE_PATH, ignoreLines, 'utf-8');
};
const outputScanLogs = async (response, imageUri, output) => {
    switch (output?.type) {
        case types_1.ScanLogsOutputType.CLOUDWATCH_LOGS:
            await outputScanLogsToCWLogs(response, output, imageUri);
            break;
        default:
            // Scan logs output to lambda default log group
            console.log('stderr:\n' + response.stderr.toString());
            console.log('stdout:\n' + response.stdout.toString());
    }
};
const outputScanLogsToCWLogs = async (response, output, imageUri) => {
    // LogStream name must satisfy regular expression pattern: `[^:*]*`.
    // So, we can't use `:` in logStreamName.
    const [uri, tag] = imageUri.split(':');
    const logStreamName = tag ? `uri=${uri},tag=${tag}` : `uri=${uri}`;
    // Ensure log stream exists before putting log events.
    try {
        await cwClient.send(new client_cloudwatch_logs_1.CreateLogStreamCommand({
            logGroupName: output.logGroupName,
            logStreamName,
        }));
    }
    catch (e) {
        // If the log stream already exists, ignore the error.
        if (e instanceof client_cloudwatch_logs_1.ResourceAlreadyExistsException) {
            console.log(`Log stream ${logStreamName} already exists in log group ${output.logGroupName}.`);
        }
        else {
            throw e;
        }
    }
    const timestamp = new Date().getTime();
    const input = {
        logGroupName: output.logGroupName,
        logStreamName: logStreamName,
        logEvents: [
            {
                timestamp,
                message: 'stderr:\n' + response.stderr.toString(),
            },
            {
                timestamp,
                message: 'stdout:\n' + response.stdout.toString(),
            },
        ],
    };
    const command = new client_cloudwatch_logs_1.PutLogEventsCommand(input);
    await cwClient.send(command);
    console.log(`Scan logs output to the log group: ${output.logGroupName}, log stream: ${logStreamName}`);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxpREFBNEQ7QUFDNUQsMkJBQW1DO0FBQ25DLDRFQU15QztBQUV6QywyQ0FLeUI7QUFFekIsTUFBTSxzQkFBc0IsR0FBRyxtQkFBbUIsQ0FBQztBQUVuRCxNQUFNLFFBQVEsR0FBRyxJQUFJLDZDQUFvQixFQUFFLENBQUM7QUFFckMsTUFBTSxPQUFPLEdBQTZCLEtBQUssV0FBVyxLQUFLO0lBQ3BFLE1BQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxXQUFXLENBQUM7SUFDdEMsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLGtCQUEyRCxDQUFDO0lBRWhGLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVE7UUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7SUFFdkYsTUFBTSxZQUFZLEdBQThCO1FBQzlDLGtCQUFrQixFQUFFLEtBQUssQ0FBQyxJQUFJO1FBQzlCLElBQUksRUFBRSxFQUErQjtLQUN0QyxDQUFDO0lBRUYsSUFBSSxXQUFXLEtBQUssUUFBUSxJQUFJLFdBQVcsS0FBSyxRQUFRLEVBQUUsQ0FBQztRQUN6RCxNQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFbkMsSUFBSSxLQUFLLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQzdCLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7WUFDakUsbUJBQW1CLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3pDLENBQUM7UUFFRCxNQUFNLEdBQUcsR0FBRyxrQ0FBa0MsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDcEYsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFDL0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRTNDLE1BQU0sUUFBUSxHQUFHLElBQUEseUJBQVMsRUFBQyxHQUFHLEVBQUU7WUFDOUIsS0FBSyxFQUFFLElBQUk7U0FDWixDQUFDLENBQUM7UUFFSCxNQUFNLGNBQWMsQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFN0QsSUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLENBQUM7WUFDdkIsTUFBTSxJQUFJLEtBQUssQ0FDYixVQUFVLFFBQVEsQ0FBQyxLQUFLLGFBQWEsUUFBUSxDQUFDLE1BQU0sYUFBYSxRQUFRLENBQUMsTUFBTSxnRkFBZ0YsQ0FDakssQ0FBQztJQUNOLENBQUM7SUFFRCxPQUFPLFlBQVksQ0FBQztBQUN0QixDQUFDLENBQUM7QUFwQ1csUUFBQSxPQUFPLFdBb0NsQjtBQUVGLE1BQU0sV0FBVyxHQUFHLENBQUMsS0FBaUMsRUFBWSxFQUFFO0lBQ2xFLE1BQU0sT0FBTyxHQUFhLEVBQUUsQ0FBQztJQUU3QixJQUFJLEtBQUssQ0FBQyxhQUFhLEtBQUssTUFBTTtRQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztJQUNyRSxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsTUFBTTtRQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsY0FBYyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDbEYsSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU07UUFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLGNBQWMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ2xGLElBQUksS0FBSyxDQUFDLG1CQUFtQixDQUFDLE1BQU07UUFDbEMsT0FBTyxDQUFDLElBQUksQ0FBQywyQkFBMkIsS0FBSyxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDakYsSUFBSSxLQUFLLENBQUMsUUFBUTtRQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsZUFBZSxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztJQUNsRSxJQUFJLEtBQUssQ0FBQyxTQUFTO1FBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUM7SUFDdEUsSUFBSSxLQUFLLENBQUMsV0FBVyxDQUFDLE1BQU07UUFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLGdCQUFnQixzQkFBc0IsRUFBRSxDQUFDLENBQUM7SUFDckYsSUFBSSxLQUFLLENBQUMsUUFBUTtRQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsY0FBYyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztJQUVqRSxPQUFPLE9BQU8sQ0FBQztBQUNqQixDQUFDLENBQUM7QUFFRixNQUFNLG1CQUFtQixHQUFHLENBQUMsV0FBcUIsRUFBRSxFQUFFO0lBQ3BELE1BQU0sV0FBVyxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDM0MsSUFBQSxrQkFBYSxFQUFDLHNCQUFzQixFQUFFLFdBQVcsRUFBRSxPQUFPLENBQUMsQ0FBQztBQUM5RCxDQUFDLENBQUM7QUFFRixNQUFNLGNBQWMsR0FBRyxLQUFLLEVBQzFCLFFBQWtDLEVBQ2xDLFFBQWdCLEVBQ2hCLE1BQThCLEVBQzlCLEVBQUU7SUFDRixRQUFRLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQztRQUNyQixLQUFLLDBCQUFrQixDQUFDLGVBQWU7WUFDckMsTUFBTSxzQkFBc0IsQ0FBQyxRQUFRLEVBQUUsTUFBcUMsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUN4RixNQUFNO1FBQ1I7WUFDRSwrQ0FBK0M7WUFDL0MsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1lBQ3RELE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztJQUMxRCxDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBRUYsTUFBTSxzQkFBc0IsR0FBRyxLQUFLLEVBQ2xDLFFBQWtDLEVBQ2xDLE1BQW1DLEVBQ25DLFFBQWdCLEVBQ2hCLEVBQUU7SUFDRixvRUFBb0U7SUFDcEUseUNBQXlDO0lBQ3pDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN2QyxNQUFNLGFBQWEsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxRQUFRLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO0lBRW5FLHNEQUFzRDtJQUN0RCxJQUFJLENBQUM7UUFDSCxNQUFNLFFBQVEsQ0FBQyxJQUFJLENBQ2pCLElBQUksK0NBQXNCLENBQUM7WUFDekIsWUFBWSxFQUFFLE1BQU0sQ0FBQyxZQUFZO1lBQ2pDLGFBQWE7U0FDZCxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1FBQ1gsc0RBQXNEO1FBQ3RELElBQUksQ0FBQyxZQUFZLHVEQUE4QixFQUFFLENBQUM7WUFDaEQsT0FBTyxDQUFDLEdBQUcsQ0FDVCxjQUFjLGFBQWEsZ0NBQWdDLE1BQU0sQ0FBQyxZQUFZLEdBQUcsQ0FDbEYsQ0FBQztRQUNKLENBQUM7YUFBTSxDQUFDO1lBQ04sTUFBTSxDQUFDLENBQUM7UUFDVixDQUFDO0lBQ0gsQ0FBQztJQUVELE1BQU0sU0FBUyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDdkMsTUFBTSxLQUFLLEdBQTZCO1FBQ3RDLFlBQVksRUFBRSxNQUFNLENBQUMsWUFBWTtRQUNqQyxhQUFhLEVBQUUsYUFBYTtRQUM1QixTQUFTLEVBQUU7WUFDVDtnQkFDRSxTQUFTO2dCQUNULE9BQU8sRUFBRSxXQUFXLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUU7YUFDbEQ7WUFDRDtnQkFDRSxTQUFTO2dCQUNULE9BQU8sRUFBRSxXQUFXLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUU7YUFDbEQ7U0FDRjtLQUNGLENBQUM7SUFDRixNQUFNLE9BQU8sR0FBRyxJQUFJLDRDQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQy9DLE1BQU0sUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUU3QixPQUFPLENBQUMsR0FBRyxDQUNULHNDQUFzQyxNQUFNLENBQUMsWUFBWSxpQkFBaUIsYUFBYSxFQUFFLENBQzFGLENBQUM7QUFDSixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzcGF3blN5bmMsIFNwYXduU3luY1JldHVybnMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCB7IHdyaXRlRmlsZVN5bmMgfSBmcm9tICdmcyc7XG5pbXBvcnQge1xuICBDbG91ZFdhdGNoTG9nc0NsaWVudCxcbiAgQ3JlYXRlTG9nU3RyZWFtQ29tbWFuZCxcbiAgUHV0TG9nRXZlbnRzQ29tbWFuZCxcbiAgUHV0TG9nRXZlbnRzQ29tbWFuZElucHV0LFxuICBSZXNvdXJjZUFscmVhZHlFeGlzdHNFeGNlcHRpb24sXG59IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1jbG91ZHdhdGNoLWxvZ3MnO1xuaW1wb3J0IHsgQ2RrQ3VzdG9tUmVzb3VyY2VIYW5kbGVyLCBDZGtDdXN0b21SZXNvdXJjZVJlc3BvbnNlIH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQge1xuICBTY2FuTG9nc091dHB1dE9wdGlvbnMsXG4gIENsb3VkV2F0Y2hMb2dzT3V0cHV0T3B0aW9ucyxcbiAgU2Nhbm5lckN1c3RvbVJlc291cmNlUHJvcHMsXG4gIFNjYW5Mb2dzT3V0cHV0VHlwZSxcbn0gZnJvbSAnLi4vLi4vc3JjL3R5cGVzJztcblxuY29uc3QgVFJJVllfSUdOT1JFX0ZJTEVfUEFUSCA9ICcvdG1wLy50cml2eWlnbm9yZSc7XG5cbmNvbnN0IGN3Q2xpZW50ID0gbmV3IENsb3VkV2F0Y2hMb2dzQ2xpZW50KCk7XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyOiBDZGtDdXN0b21SZXNvdXJjZUhhbmRsZXIgPSBhc3luYyBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgY29uc3QgcmVxdWVzdFR5cGUgPSBldmVudC5SZXF1ZXN0VHlwZTtcbiAgY29uc3QgcHJvcHMgPSBldmVudC5SZXNvdXJjZVByb3BlcnRpZXMgYXMgdW5rbm93biBhcyBTY2FubmVyQ3VzdG9tUmVzb3VyY2VQcm9wcztcblxuICBpZiAoIXByb3BzLmFkZHIgfHwgIXByb3BzLmltYWdlVXJpKSB0aHJvdyBuZXcgRXJyb3IoJ2FkZHIgYW5kIGltYWdlVXJpIGFyZSByZXF1aXJlZC4nKTtcblxuICBjb25zdCBmdW5jUmVzcG9uc2U6IENka0N1c3RvbVJlc291cmNlUmVzcG9uc2UgPSB7XG4gICAgUGh5c2ljYWxSZXNvdXJjZUlkOiBwcm9wcy5hZGRyLFxuICAgIERhdGE6IHt9IGFzIHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0sXG4gIH07XG5cbiAgaWYgKHJlcXVlc3RUeXBlID09PSAnQ3JlYXRlJyB8fCByZXF1ZXN0VHlwZSA9PT0gJ1VwZGF0ZScpIHtcbiAgICBjb25zdCBvcHRpb25zID0gbWFrZU9wdGlvbnMocHJvcHMpO1xuXG4gICAgaWYgKHByb3BzLnRyaXZ5SWdub3JlLmxlbmd0aCkge1xuICAgICAgY29uc29sZS5sb2coJ3RyaXZ5aWdub3JlOiAnICsgSlNPTi5zdHJpbmdpZnkocHJvcHMudHJpdnlJZ25vcmUpKTtcbiAgICAgIG1ha2VUcml2eUlnbm9yZUZpbGUocHJvcHMudHJpdnlJZ25vcmUpO1xuICAgIH1cblxuICAgIGNvbnN0IGNtZCA9IGAvb3B0L3RyaXZ5IGltYWdlIC0tbm8tcHJvZ3Jlc3MgJHtvcHRpb25zLmpvaW4oJyAnKX0gJHtwcm9wcy5pbWFnZVVyaX1gO1xuICAgIGNvbnNvbGUubG9nKCdjb21tYW5kOiAnICsgY21kKTtcbiAgICBjb25zb2xlLmxvZygnaW1hZ2VVcmk6ICcgKyBwcm9wcy5pbWFnZVVyaSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IHNwYXduU3luYyhjbWQsIHtcbiAgICAgIHNoZWxsOiB0cnVlLFxuICAgIH0pO1xuXG4gICAgYXdhaXQgb3V0cHV0U2NhbkxvZ3MocmVzcG9uc2UsIHByb3BzLmltYWdlVXJpLCBwcm9wcy5vdXRwdXQpO1xuXG4gICAgaWYgKHJlc3BvbnNlLnN0YXR1cyAhPT0gMClcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEVycm9yOiAke3Jlc3BvbnNlLmVycm9yfVxcblNpZ25hbDogJHtyZXNwb25zZS5zaWduYWx9XFxuU3RhdHVzOiAke3Jlc3BvbnNlLnN0YXR1c31cXG5JbWFnZSBTY2FubmVyIHJldHVybmVkIGZhdGFsIGVycm9ycy4gWW91IG1heSBoYXZlIHZ1bG5lcmFiaWxpdGllcy4gU2VlIGxvZ3MuYCxcbiAgICAgICk7XG4gIH1cblxuICByZXR1cm4gZnVuY1Jlc3BvbnNlO1xufTtcblxuY29uc3QgbWFrZU9wdGlvbnMgPSAocHJvcHM6IFNjYW5uZXJDdXN0b21SZXNvdXJjZVByb3BzKTogc3RyaW5nW10gPT4ge1xuICBjb25zdCBvcHRpb25zOiBzdHJpbmdbXSA9IFtdO1xuXG4gIGlmIChwcm9wcy5pZ25vcmVVbmZpeGVkID09PSAndHJ1ZScpIG9wdGlvbnMucHVzaCgnLS1pZ25vcmUtdW5maXhlZCcpO1xuICBpZiAocHJvcHMuc2V2ZXJpdHkubGVuZ3RoKSBvcHRpb25zLnB1c2goYC0tc2V2ZXJpdHkgJHtwcm9wcy5zZXZlcml0eS5qb2luKCcsJyl9YCk7XG4gIGlmIChwcm9wcy5zY2FubmVycy5sZW5ndGgpIG9wdGlvbnMucHVzaChgLS1zY2FubmVycyAke3Byb3BzLnNjYW5uZXJzLmpvaW4oJywnKX1gKTtcbiAgaWYgKHByb3BzLmltYWdlQ29uZmlnU2Nhbm5lcnMubGVuZ3RoKVxuICAgIG9wdGlvbnMucHVzaChgLS1pbWFnZS1jb25maWctc2Nhbm5lcnMgJHtwcm9wcy5pbWFnZUNvbmZpZ1NjYW5uZXJzLmpvaW4oJywnKX1gKTtcbiAgaWYgKHByb3BzLmV4aXRDb2RlKSBvcHRpb25zLnB1c2goYC0tZXhpdC1jb2RlICR7cHJvcHMuZXhpdENvZGV9YCk7XG4gIGlmIChwcm9wcy5leGl0T25Fb2wpIG9wdGlvbnMucHVzaChgLS1leGl0LW9uLWVvbCAke3Byb3BzLmV4aXRPbkVvbH1gKTtcbiAgaWYgKHByb3BzLnRyaXZ5SWdub3JlLmxlbmd0aCkgb3B0aW9ucy5wdXNoKGAtLWlnbm9yZWZpbGUgJHtUUklWWV9JR05PUkVfRklMRV9QQVRIfWApO1xuICBpZiAocHJvcHMucGxhdGZvcm0pIG9wdGlvbnMucHVzaChgLS1wbGF0Zm9ybSAke3Byb3BzLnBsYXRmb3JtfWApO1xuXG4gIHJldHVybiBvcHRpb25zO1xufTtcblxuY29uc3QgbWFrZVRyaXZ5SWdub3JlRmlsZSA9ICh0cml2eUlnbm9yZTogc3RyaW5nW10pID0+IHtcbiAgY29uc3QgaWdub3JlTGluZXMgPSB0cml2eUlnbm9yZS5qb2luKCdcXG4nKTtcbiAgd3JpdGVGaWxlU3luYyhUUklWWV9JR05PUkVfRklMRV9QQVRILCBpZ25vcmVMaW5lcywgJ3V0Zi04Jyk7XG59O1xuXG5jb25zdCBvdXRwdXRTY2FuTG9ncyA9IGFzeW5jIChcbiAgcmVzcG9uc2U6IFNwYXduU3luY1JldHVybnM8QnVmZmVyPixcbiAgaW1hZ2VVcmk6IHN0cmluZyxcbiAgb3V0cHV0PzogU2NhbkxvZ3NPdXRwdXRPcHRpb25zLFxuKSA9PiB7XG4gIHN3aXRjaCAob3V0cHV0Py50eXBlKSB7XG4gICAgY2FzZSBTY2FuTG9nc091dHB1dFR5cGUuQ0xPVURXQVRDSF9MT0dTOlxuICAgICAgYXdhaXQgb3V0cHV0U2NhbkxvZ3NUb0NXTG9ncyhyZXNwb25zZSwgb3V0cHV0IGFzIENsb3VkV2F0Y2hMb2dzT3V0cHV0T3B0aW9ucywgaW1hZ2VVcmkpO1xuICAgICAgYnJlYWs7XG4gICAgZGVmYXVsdDpcbiAgICAgIC8vIFNjYW4gbG9ncyBvdXRwdXQgdG8gbGFtYmRhIGRlZmF1bHQgbG9nIGdyb3VwXG4gICAgICBjb25zb2xlLmxvZygnc3RkZXJyOlxcbicgKyByZXNwb25zZS5zdGRlcnIudG9TdHJpbmcoKSk7XG4gICAgICBjb25zb2xlLmxvZygnc3Rkb3V0OlxcbicgKyByZXNwb25zZS5zdGRvdXQudG9TdHJpbmcoKSk7XG4gIH1cbn07XG5cbmNvbnN0IG91dHB1dFNjYW5Mb2dzVG9DV0xvZ3MgPSBhc3luYyAoXG4gIHJlc3BvbnNlOiBTcGF3blN5bmNSZXR1cm5zPEJ1ZmZlcj4sXG4gIG91dHB1dDogQ2xvdWRXYXRjaExvZ3NPdXRwdXRPcHRpb25zLFxuICBpbWFnZVVyaTogc3RyaW5nLFxuKSA9PiB7XG4gIC8vIExvZ1N0cmVhbSBuYW1lIG11c3Qgc2F0aXNmeSByZWd1bGFyIGV4cHJlc3Npb24gcGF0dGVybjogYFteOipdKmAuXG4gIC8vIFNvLCB3ZSBjYW4ndCB1c2UgYDpgIGluIGxvZ1N0cmVhbU5hbWUuXG4gIGNvbnN0IFt1cmksIHRhZ10gPSBpbWFnZVVyaS5zcGxpdCgnOicpO1xuICBjb25zdCBsb2dTdHJlYW1OYW1lID0gdGFnID8gYHVyaT0ke3VyaX0sdGFnPSR7dGFnfWAgOiBgdXJpPSR7dXJpfWA7XG5cbiAgLy8gRW5zdXJlIGxvZyBzdHJlYW0gZXhpc3RzIGJlZm9yZSBwdXR0aW5nIGxvZyBldmVudHMuXG4gIHRyeSB7XG4gICAgYXdhaXQgY3dDbGllbnQuc2VuZChcbiAgICAgIG5ldyBDcmVhdGVMb2dTdHJlYW1Db21tYW5kKHtcbiAgICAgICAgbG9nR3JvdXBOYW1lOiBvdXRwdXQubG9nR3JvdXBOYW1lLFxuICAgICAgICBsb2dTdHJlYW1OYW1lLFxuICAgICAgfSksXG4gICAgKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIC8vIElmIHRoZSBsb2cgc3RyZWFtIGFscmVhZHkgZXhpc3RzLCBpZ25vcmUgdGhlIGVycm9yLlxuICAgIGlmIChlIGluc3RhbmNlb2YgUmVzb3VyY2VBbHJlYWR5RXhpc3RzRXhjZXB0aW9uKSB7XG4gICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgYExvZyBzdHJlYW0gJHtsb2dTdHJlYW1OYW1lfSBhbHJlYWR5IGV4aXN0cyBpbiBsb2cgZ3JvdXAgJHtvdXRwdXQubG9nR3JvdXBOYW1lfS5gLFxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgZTtcbiAgICB9XG4gIH1cblxuICBjb25zdCB0aW1lc3RhbXAgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgY29uc3QgaW5wdXQ6IFB1dExvZ0V2ZW50c0NvbW1hbmRJbnB1dCA9IHtcbiAgICBsb2dHcm91cE5hbWU6IG91dHB1dC5sb2dHcm91cE5hbWUsXG4gICAgbG9nU3RyZWFtTmFtZTogbG9nU3RyZWFtTmFtZSxcbiAgICBsb2dFdmVudHM6IFtcbiAgICAgIHtcbiAgICAgICAgdGltZXN0YW1wLFxuICAgICAgICBtZXNzYWdlOiAnc3RkZXJyOlxcbicgKyByZXNwb25zZS5zdGRlcnIudG9TdHJpbmcoKSxcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHRpbWVzdGFtcCxcbiAgICAgICAgbWVzc2FnZTogJ3N0ZG91dDpcXG4nICsgcmVzcG9uc2Uuc3Rkb3V0LnRvU3RyaW5nKCksXG4gICAgICB9LFxuICAgIF0sXG4gIH07XG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgUHV0TG9nRXZlbnRzQ29tbWFuZChpbnB1dCk7XG4gIGF3YWl0IGN3Q2xpZW50LnNlbmQoY29tbWFuZCk7XG5cbiAgY29uc29sZS5sb2coXG4gICAgYFNjYW4gbG9ncyBvdXRwdXQgdG8gdGhlIGxvZyBncm91cDogJHtvdXRwdXQubG9nR3JvdXBOYW1lfSwgbG9nIHN0cmVhbTogJHtsb2dTdHJlYW1OYW1lfWAsXG4gICk7XG59O1xuIl19